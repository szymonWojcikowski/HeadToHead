<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>H2H App v. 0</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
  <link rel="stylesheet" href="style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
</head>
<body>
<div class="container">
   <header class="row">
     <div class="col-md-12">
       <h1 class="text-center text-secondary">Head 2 Head</h1>
       <h2 class="text-center text-warning">Lego truckers's comparison</h2>
       <div class="alert alert-warning alert-dismissible" role="alert">
          <code><strong>How to:</strong> Select a first trucker. U will see his stats (total number of races, number of wins, second, and third places, percentage of wins). Now choose his oponent. You will see his stats also. Now click "compare" button. You will see a results of direct duels (such total namber of wins, loss and draws, percentage of direct wins).</code> 
          <button type="button" class="close" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
          </button>
        </div>
       
     </div>
   </header>
   <section class="row">
       <div class="col-sm-6 bg-secondary card-body">
           <div class="form-group">
              <label for="firstSelect" class="text-white">Select a trucker</label>
              <select class="form-control" id="firstSelect">
<!--options generated via js -->
              </select>
            </div>
       </div>
       
       <div class="col-sm-6 bg-danger card-body">
          <div class="form-group">
            <label for="selectoToCompare" class="text-light">...and choose his contestant</label>
            <select class="form-control" id="selectoToCompare">
<!--options generated via js -->
            </select>
          </div>
       </div>
   </section>
    <section class="row">
        <div class="col-sm-6 text-center bg-secondary" id="stats">
        </div>
        <div class="col-sm-6 text-center bg-danger" id="stats2">
        </div>
 
    </section>
    <section class="row">  
        <div class="col-sm-12 text-center" id="comparison">
        </div>
    </section>
   <section class="row">
        <div class="col-sm-12 card-body text-center">
         <button type="button" class="btn btn-lg btn-success" id="compareBtn">Compare</button>
      </div>
   </section>
   

   
</div>
<!----------------bootstrap4 i jego pomocnicy--------------->
 <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
 <script>
// wyniki rajdów =
var raceInfo = [
//   const GPM 2007 #1 = 
   {
        year: 2007,
        race: 1,
        competitors: ["Pietruch", "smyk", "Aro_Kal", "Lomero"], 
        position:["1","2","3","4"]  
  },

//   const GPM 2007 #2 = 
   {
        year: 2007,
        race: 2,
        competitors: ["smyk", "Duke", "Pietruch", "Sariel", "Liwnik"],
        position:["1","2","3","4","5"] 
  },

//   const GPM 2007 #3  = 
  {
        year: 2007,
        race: 3,
        competitors: ["Duke", "M. Drwięga", "Pietruch", "smyk", "Sariel"],
        position:["1","2","3","4","5"] 
   },
   
//   const GPM 2007 #4 = 
   {
        year: 2007,
        race: 4,  
        competitors: ["Aro_Kal", "Pietruch", "Sariel", "smyk", "Duke"], 
        position:["1","2","3","4","5"] 
  },
    {
        year: 2008,
        race: 1, 
        competitors: ["Duke", "smyk", "Aro_Kal", "Lomero", "Pietruch", "Emilus", "Richard"],
        position:["1","2","3","4","5","6","7"]
    },
    {
        year: 2008,
        race: 2,
        competitors: ["Duke", "smyk", "Aro_Kal", "Emilus", "Sariel"], 
        position:["1","2","3","4","5"]  
  },
    {
       year: 2008,
       race: 3,
       competitors: ["Duke", "smyk", "Emilus", "Lomero", "Richard"], 
       position:["1","2","3","4","5"]  
  },
    {
        year: 2008,
        race: 4,
        competitors: ["smyk", "Duke", "Emilus"], 
        position:["1","2","3"] 
  },
    {
        year: 2008,
        race: 5,
        competitors: ["Duke", "Emilus", "Lomero", "Skuter", "smyk"], 
        position:["1","2","3","4","5"] 
  },
    {
        year: 2008,
        race: 6,
        competitors: ["Emilus", "Aro_Kal", "Duke", "Lomero"], 
        position:["1","2","3","4"] 
  },
 {
        year: 2009,
        race: 1,
        competitors: ["TT", "smyk", "Emilus", "Aro_Kal", "Maniek", "Duke", "Atros"], 
        position:["1","2","3","4","5","6","7"] 
  },
  {
        year: 2009,
        race: 2,
        competitors: ["Aro_Kal", "Lomero", "Maniek", "Atros", "smyk", "Duke", "Emilus"], 
        position:["1","2","3","4","5","6","7"] 
  }
   ];

 var drawResults = function(rYear, rRace, rPosition, rCompetitor, j) {
   var j = j;
   var rPosition = raceInfo[i].position[j];
   var rCompetitor = raceInfo[i].competitors[j];

   if (rPosition != undefined) {
        console.info(rPosition + " miejsce: " + rCompetitor);
   }
 }
   
     var testCounter = 1;
     
     var test = function() {
         console.log("Test nr: " + testCounter);
         testCounter++;
     }

//---------tablica zbierająca z każdego rajdu liczbę uczestników ---------
     var howMany = [];  
    
     raceInfo.forEach((el) => {
         howMany.push(el.position.length);
         console.log("Startowało: " + el.position.length);   
     });

//---------sprawdzamy maksymalną liczbę uczestników------------------------
     var mostCompetitors = Math.max(...howMany);
     console.info("Max: " + mostCompetitors);
     console.log("----------------------");
   

//----------pętle wywołujące funkcję wyświetlającą wyniki w konsoli---------   
     for (var i = 0; i < raceInfo.length; i++) {
        console.info(raceInfo[i].year + " race#" + raceInfo[i].race);
        for (var j = 0; j < mostCompetitors; j++) {
            drawResults(raceInfo[i].year, raceInfo[i].race, raceInfo[i].position, raceInfo[i].competitors, j);
        } 
        console.log("-------------");
      }
   
   
   var showPosition = function(raceNr, who) {
       var idWho = raceInfo[raceNr].competitors.indexOf(who);
       var raceNumber = 1 + parseInt(raceNr);
       var whoPosition = raceInfo[raceNr].position[idWho];
       console.log(who + " na rajdzie " + raceNumber + " był " + whoPosition);
   }
   
   
   // wartości testowe wyrażenia funkcyjnego showPosition
   showPosition("0", "smyk");
   showPosition("1", "smyk");
   //showPosition("5", "smyk"); <--wywołanie rajdu którego nie ma wysypuje kod (trzeba dodać obsługę błędów)
    showPosition("4", "abc"); // wywołanie zawodnika, który nie istniał daje undefined i kod wykonuje się dalej

    
//------------tworzymy tablicę ze wszystkich pojedyńczych występów na rajdzie-------------------
   
var competitorsToSelect = [];
for (var i = 0; i < raceInfo.length; i++) {
  competitorsToSelect = competitorsToSelect.concat(raceInfo[i].competitors);
  console.info("pętla nr " + i + ", dodani uczestnicy " + raceInfo[i].competitors);
}
console.info("competitorsToSelect " + competitorsToSelect);
  
//---------------pozostawienie unikatów, skreślenie duplikatów z tablicy competitorsToSelect----------------------
   
Array.prototype.contains = function(v) {
  for(var i = 0; i < this.length; i++) {
    if(this[i] === v) return true;
  }
  return false;
};
     
Array.prototype.unique = function() {
  var arr = [];
  for(var i = 0; i < this.length; i++) {
    if(!arr.contains(this[i])) {
      arr.push(this[i]);
    }
}
  return arr; 
}

var uniques = competitorsToSelect.unique(); 
     
console.log("Zawodnicy do wyboru: " + uniques + " Jest " + uniques.length + " zawodników do wyboru.");
   
     
// source MDN
for(var i = 0; i < uniques.length; i++) {
  function addElement(i) {
    var mySelect = null;
    var newElOption = null;
    newElOption = document.createElement("option");
    newElOption.innerHTML = uniques[i];
    mySelect = document.getElementById("firstSelect");
    mySelect.appendChild(newElOption);
  }
  addElement(i);
}


/*------------funkcja do wyświetlania statystyk pierwszego zawodnika i... generująca opcje wyboru do drugiego selecta (warto wydzielić)---------*/
    var showSelectedTruckerAndDisplayStats = function showSelectedTruckerAndDisplayStats() {
          console.log("startuejmy");
          var select = document.getElementById("firstSelect");
          var selectedOption = select.options[select.selectedIndex];
          var selectedText   = selectedOption.text;  // 'dane'
          var selectedValue  = selectedOption.value; // 'wartość'
      
          var showSelect = function showSelect() {
               console.log("Wybrano zawodnika " + selectedText);
          }
          showSelect();
      
              //------statsDisplay---------
          var showMeStats = function showMeStats(raceInfo) {
               var raceInfo = raceInfo;
               console.warn("Czy przekazał zawodnika? " + selectedText);
               console.error("Czy przekazał rajdy? " + raceInfo);


            //--------------pętla zliaczająca pozycje do statystyk----------
                var absent = 0;
                var winner = 0;
                var second = 0;
                var third = 0;
                var podium = 0;
                var furtherPlaces = 0;
                var competed = 0;
                var frequency = 0;
                var miejsca = [];
                var numOfParticipants = [];
               
                for (var i = 0; i < raceInfo.length; i++) {
                  console.log("W pętli " + raceInfo[i].position);
                  console.log(selectedText);
                  var raceInfo = raceInfo;
                  var i = i;
                  var chosenIndex = raceInfo[i].competitors.indexOf(selectedText);
                  var positionToPush = raceInfo[i].position[chosenIndex];
                  var numOfParticipantsToPush = raceInfo[i].position.length;
                  
                  if (positionToPush != undefined) {
                      miejsca.push(positionToPush);
                      numOfParticipants.push(numOfParticipantsToPush);
                  }

                  if (raceInfo[i].position[chosenIndex] == 1) {
                
                    winner++;
                    competed++;
                    podium++;
                  } 
                  else if (raceInfo[i].position[chosenIndex] == 2) {
                    second++;
                    competed++;
                    podium++;
                  }
                  else if (raceInfo[i].position[chosenIndex] == 3) {
                    third++;
                    competed++;
                    podium++;
                  }
                  else if (raceInfo[i].position[chosenIndex] == undefined) {
                    absent++;
                  }
                  else {
                    console.log("Zawodnik " + selectedText);
                    console.warn("Dalsze miejsce " + raceInfo[i].position[chosenIndex] + " na " + raceInfo[i].position.length);


                    furtherPlaces++;
                    competed++;
                  }
                }
            
            //-------statystyki procentowe wyliczane po warunkach zliczających----
                var frequency = competed/raceInfo.length;
                var winsPct = winner/competed;
                var podiumPct = podium/competed;
            
                var fSumOfComp = function su(numOfParticipants) {
                   var sumOfComp = 0;
                    for(var i = 0; i < numOfParticipants.length; i++) { 
                      sumOfComp = sumOfComp + parseInt(numOfParticipants[i]); 
                      console.warn("wewnetrzny Test funkcji su " + sumOfComp);
                    }
                  console.error("Czy poza petlą jest co przekazać? " + sumOfComp);
                  return sumOfComp; 
                }
            
                var fSumOfPos = function suma(miejsca) {
                    var sumOfPos = 0;
                    for(var i = 0; i < miejsca.length; i++) { 
                      sumOfPos = sumOfPos + parseInt(miejsca[i]); 
                      console.error("Test funkcji suma " + sumOfPos + " wsad: " + miejsca);
                    }
                    return sumOfPos; 
                }


                var per = function per(fSumOfPos, fSumOfComp) {
                    var positionPerNumOfCompetitors = fSumOfPos(miejsca)/fSumOfComp(numOfParticipants);
                    return positionPerNumOfCompetitors;
                }

            
              var statsDisplay = document.getElementById("stats");
              const st = "<div class=\"row no-gutters\"><div class=\"col-sm-7\">";
              const mid = "</div><div class=\"col-sm-5\">";
              const end = "</div></div>";
              statsDisplay.innerHTML = 
                 st + "wystartował " + mid + competed + end +
                 st + "nie startował " + mid + absent + end +
                 st + "frekwencja " + mid + frequency.toFixed(3)*100 + "%" + end +
                 st + "pierwszy " + mid + winner + end +
                 st + "drugi " + mid + second + end +
                 st + "trzeci " + mid + third + end + 
                 st + "na podium " + mid + podium + end +
                 st + "procent wygranych " + mid + winsPct.toFixed(3)*100 + "%" + end +
                 st + "procent na podium " + mid + podiumPct.toFixed(3)*100 + "%" + end +
                 st + "dalsze miejsce " + mid + furtherPlaces + end + 
                 st + "rajd po rajdzie " + mid + miejsca + end +
                 st + "a startowało " + mid + numOfParticipants + end +
                 st + "pozycja na liczbę startujących " + mid + per(fSumOfPos, fSumOfComp).toFixed(3) + end;    
          }
          //"<table class=\"table table-sm table-striped\"><tbody>" +
          //"</tbody></table>";
          showMeStats(raceInfo);
        
          function truckersToCompare() {
            var select = document.getElementById("firstSelect");
            var selectedOption = select.options[select.selectedIndex];
            var selectedText = selectedOption.text;
            var idOfSelected = uniques.indexOf(selectedText);
            var avilableToCompare =[];
            avilableToCompare = uniques.filter(function(el) {
                return el != selectedOption.text;
            });
            console.log("możliwi do porównania " + avilableToCompare + " | " + avilableToCompare.length + " zaznaczone " + idOfSelected);
              return avilableToCompare;
          }
           console.log("Sprawdzam możliwości porównania: " + truckersToCompare());
        
        
        //polyfill dla przeglądarek nie obsługujących closest
            if (!Element.prototype.remove) {
                Element.prototype.remove = function() {
                    this.parentElement.removeChild(this);
                }
            }
        
            var selectToClear = document.getElementById("selectoToCompare");
            
            while (selectToClear.firstChild) {
                selectToClear.removeChild(selectToClear.firstChild);
            }
        //--------------pętla dodające option do selecta 
            for(var i = 0; i < truckersToCompare().length; i++) {
                function addEl(i) {
                    var mySelect = null;
                    var newElOption = null;
                    newElOption = document.createElement("option");
                    newElOption.innerHTML = truckersToCompare()[i];

                    mySelect = document.getElementById("selectoToCompare");
                    mySelect.removeChild
                    mySelect.appendChild(newElOption);
                }
                addEl(i);
            }
    }
   
  /*---------- f pokazująca statystyki drugiego wybranego kierowcy --start-----*/  
       var showSelectedTruckerAndDisplayStats2 = function showSelectedTruckerAndDisplayStats2() {
          console.log("Test pokazywania statystyk drugiego zawodnika");
          var select = document.getElementById("selectoToCompare");
          var selectedOption = select.options[select.selectedIndex];
          var selectedText   = selectedOption.text;  // 'dane'
          var selectedValue  = selectedOption.value; // 'wartość'
      
          var showSelect = function showSelect() {
               console.log("Wybrano zawodnika " + selectedText);
          }
          showSelect();
      
              //------statsDisplay---------
          var showMeStats = function showMeStats(raceInfo) {
               var raceInfo = raceInfo;
               console.warn("Drugi wybrany zawodnik " + selectedText);
               console.error("Czy przekazał rajdy? " + raceInfo);

            //--------------pętla zliaczająca pozycje do statystyk----------
                
                var absent = 0;
                var winner = 0;
                var second = 0;
                var third = 0;
                var podium = 0;
                var furtherPlaces = 0;
                var competed = 0;
                var frequency = 0;
                var miejsca = [];
                var numOfParticipants = [];
               
            
                for (var i = 0; i < raceInfo.length; i++) {
                  console.log("W pętli " + raceInfo[i].position);
                  console.log(selectedText);
                  var raceInfo = raceInfo;
                  var i = i;
                  var chosenIndex = raceInfo[i].competitors.indexOf(selectedText);
                  var positionToPush = raceInfo[i].position[chosenIndex];
                  var numOfParticipantsToPush = raceInfo[i].position.length;
                  
                  if (positionToPush != undefined) {
                      miejsca.push(positionToPush);
                      numOfParticipants.push(numOfParticipantsToPush);
                  }
                 // var selectedText = selectedText;
                  if (raceInfo[i].position[chosenIndex] == 1) {
                
                    winner++;
                    competed++;
                    podium++;
                  } 
                  else if (raceInfo[i].position[chosenIndex] == 2) {
                    second++;
                    competed++;
                    podium++;
                  }
                  else if (raceInfo[i].position[chosenIndex] == 3) {
                    third++;
                    competed++;
                    podium++;
                  }
                  else if (raceInfo[i].position[chosenIndex] == undefined) {
                    absent++;
                  }
                  else {
                    console.log("Zawodnik " + selectedText);
                    console.warn("Dalsze miejsce " + raceInfo[i].position[chosenIndex] + " na " + raceInfo[i].position.length);


                    furtherPlaces++;
                    competed++;
                  }
                }
            
            //-------statystyki procentowe wyliczane po warunkach zliczających----
                var frequency = competed/raceInfo.length;
                var winsPct = winner/competed;
                var podiumPct = podium/competed;
            
                var fSumOfComp = function su(numOfParticipants) {
                   var sumOfComp = 0;
                    for(var i = 0; i < numOfParticipants.length; i++) { 
                      sumOfComp = sumOfComp + parseInt(numOfParticipants[i]); 
                      console.warn("wewnetrzny Test funkcji su " + sumOfComp);
                    }
                  console.error("Czy poza petlą jest co przekazać? " + sumOfComp);
                  return sumOfComp; 
                }
            
                var fSumOfPos = function suma(miejsca) {
                    var sumOfPos = 0;
                    for(var i = 0; i < miejsca.length; i++) { 
                      sumOfPos = sumOfPos + parseInt(miejsca[i]); 
                      console.error("Test funkcji suma " + sumOfPos + " wsad: " + miejsca);
                    }
                    return sumOfPos; 
                }

                var per = function per(fSumOfPos, fSumOfComp) {
                    var positionPerNumOfCompetitors = fSumOfPos(miejsca)/fSumOfComp(numOfParticipants);
                    return positionPerNumOfCompetitors;
                }
            
              var statsDisplay = document.getElementById("stats2");
              var st = "<div class=\"row no-gutters\"><div class=\"col-sm-7\">";
              var mid = "</div><div class=\"col-sm-5\">";
              var end = "</div></div>";
              statsDisplay.innerHTML = 
                 st + "wystartował " + mid + competed + end +
                 st + "nie startował " + mid + absent + end +
                 st + "frekwencja " + mid + frequency.toFixed(3)*100 + "%" + end +
                 st + "pierwszy " + mid + winner + end +
                 st + "drugi " + mid + second + end +
                 st + "trzeci " + mid + third + end + 
                 st + "na podium " + mid + podium + end +
                 st + "procent wygranych " + mid + winsPct.toFixed(3)*100 + "%" + end +
                 st + "procent na podium " + mid + podiumPct.toFixed(3)*100 + "%" + end +
                 st + "dalsze miejsce " + mid + furtherPlaces + end + 
                 st + "rajd po rajdzie " + mid + miejsca + end +
                 st + "a startowało " + mid + numOfParticipants + end +
                 st + "pozycja na liczbę startujących " + mid + per(fSumOfPos, fSumOfComp).toFixed(3) + end; 
          }
          showMeStats(raceInfo);
      } 
   

     //-----------z kursu o formularzach: http://kursjs.pl/kurs/formularze/formularze.php----
     const selectA = document.getElementById("firstSelect");

     selectA.addEventListener("change", function() {
         var who1 = this.options[this.selectedIndex].value;
         console.error('Wybrałeś: ' + this.options[this.selectedIndex].value);

         showSelectedTruckerAndDisplayStats(who1);
         var compareDisplay = document.getElementById("comparison");
         compareDisplay.innerHTML = "";
     });
     
     
    const selectB = document.getElementById("selectoToCompare");

     selectB.addEventListener("change", function() {
         var who2 = this.options[this.selectedIndex].value;
         console.error('Wybrałeś: ' + this.options[this.selectedIndex].value);
         showSelectedTruckerAndDisplayStats2(who2);
         var compareDisplay = document.getElementById("comparison");
         compareDisplay.innerHTML = "";
     });
     

   
/* funkcja do porównywania wyników zawodników - wymaga sprawdzenia-------------------*/
    var vs = function() {
        var select1 = document.getElementById("firstSelect");
        var selectedOption1 = select1.options[select1.selectedIndex];
        var selectedText1 = selectedOption1.text;
        var who1 = selectedText1;
        
        var select2 = document.getElementById("selectoToCompare");
        var selectedOption2 = select2.options[select2.selectedIndex];
        var selectedText2 = selectedOption2.text;
        var who2 = selectedText2;
        
        var who1Score = 0;
        var who2Score = 0;
        var draw = 0; 
        
        for (var i = 0; i < raceInfo.length; i++) {
            var who1Id = raceInfo[i].competitors.indexOf(who1);//index danego kierowcy w tabeli uczestników danego rajdu[i]
            var who2Id = raceInfo[i].competitors.indexOf(who2); //jw
            var who1Pos = raceInfo[i].position[who1Id];//pozycja z tabeli wzięta po odpowiadającym indexie z tabeli uczestników
            var who2Pos = raceInfo[i].position[who2Id];//jw
            var raceCounter = 1+i;
            console.group();
              console.warn(who1 + " vs " + who2);
              console.log("Race#" + raceCounter + " (" + raceInfo[i].year + " #" + raceInfo[i].race + ")");
              console.log(who1 + " był " + raceInfo[i].position[who1Id], "a " + who2 + " był " + raceInfo[i].position[who2Id]);
            console.groupEnd();
            if (who1Pos && who2Pos !== undefined) {
                if (who1Pos < who2Pos) {
                    who1Score++;
                }
                 else if (who2Pos < who1Pos) {
                    who2Score++;
                }
                 else {
                     draw++;
                 }
             }
         }
         console.log("---< Wynik H2H >---");
         console.info(who1 + " był wyżej " + who1Score);
         console.info(who2 + " był wyżej " + who2Score);
         console.info("remis był: " + draw);
         var compareDisplay = document.getElementById("comparison");
         compareDisplay.innerHTML = 
             "<section class=\"row\"><div class=\"col-sm-12 bg-dark text-light\"><strong>Funkcja porównywania kierowców H2H w trakcie przygotowania</strong><br>" +
             who1 + " wygrał " + who1Score + "<br>" +
             who2 + " wygrał " + who2Score + "<br>" +
             "remis był: " + draw + "</section></div>";     
     }    
   
   
   
var compareBtn = document.getElementById("compareBtn");
compareBtn.addEventListener("click", vs, false); 
    
  </script>
 </body>
</html>  
